<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿç‰©å“è³ªæƒæå™¨ - æ¸›è„‚åŠ©æ‰‹</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        #reader {
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .result-card {
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .product-name {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .grade-badge {
            display: inline-block;
            padding: 10px 30px;
            border-radius: 50px;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .grade-splus { background: #4CAF50; color: white; }
        .grade-a { background: #8BC34A; color: white; }
        .grade-b { background: #FFC107; color: #333; }
        .grade-f { background: #F44336; color: white; }

        .nutrition-info {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .nutrition-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .nutrition-label {
            color: #666;
        }

        .nutrition-value {
            font-weight: bold;
            color: #333;
        }

        .score-section {
            margin-top: 20px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .score-label {
            font-size: 14px;
            color: #666;
        }

        .score-value {
            font-weight: bold;
            font-size: 16px;
        }

        .score-pass { color: #4CAF50; }
        .score-fail { color: #F44336; }

        .recommendation {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        .recommendation h3 {
            font-size: 16px;
            color: #1976D2;
            margin-bottom: 8px;
        }

        .recommendation p {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            border-radius: 5px;
            color: #c62828;
            display: none;
        }

        .manual-input {
            margin-top: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        #scanner-status {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .add-product-form {
            display: none;
            background: #fff9e6;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .add-product-form h3 {
            color: #f57c00;
            margin-bottom: 15px;
        }

        .success-message {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            border-radius: 5px;
            color: #2e7d32;
            display: none;
            margin-top: 15px;
        }

        .product-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .product-item {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-item-info {
            flex: 1;
        }

        .product-item-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .product-item-barcode {
            font-size: 12px;
            color: #666;
        }

        .btn-delete {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: #e0e0e0;
            color: #666;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” é£Ÿç‰©å“è³ªæƒæå™¨</h1>
            <p>æƒææ¢ç¢¼ï¼Œç«‹å³è©•ä¼°æ¸›è„‚æ•ˆç‡</p>
        </div>

        <div class="card">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('scan')">æƒææ¢ç¢¼</button>
                <button class="tab-btn" onclick="switchTab('database')">æˆ‘çš„è³‡æ–™åº«</button>
            </div>

            <div id="scanTab" class="tab-content active">
                <div id="scanner-status">æº–å‚™æƒæ...</div>
                <div id="reader"></div>
                <button id="startScanBtn" class="btn btn-primary">ğŸ“· é–‹å§‹æƒææ¢ç¢¼</button>
                <button id="stopScanBtn" class="btn btn-secondary" style="display: none;">â¹ åœæ­¢æƒæ</button>

                <div class="add-product-form" id="addProductForm">
                    <h3>æ­¤æ¢ç¢¼å°šæœªå»ºæª”ï¼Œè«‹è¼¸å…¥å•†å“è³‡è¨Š</h3>
                    <div class="input-group">
                        <label>æ¢ç¢¼è™Ÿç¢¼</label>
                        <input type="text" id="newBarcode" readonly>
                    </div>
                    <div class="input-group">
                        <label>å•†å“åç¨±</label>
                        <input type="text" id="newProductName" placeholder="ä¾‹ï¼šå…¨å®¶é›èƒ¸è‚‰">
                    </div>
                    <div class="input-group">
                        <label>ç†±é‡ (kcal)</label>
                        <input type="number" id="newCalories" placeholder="ä¾‹ï¼š250">
                    </div>
                    <div class="input-group">
                        <label>è›‹ç™½è³ª (g)</label>
                        <input type="number" id="newProtein" placeholder="ä¾‹ï¼š20">
                    </div>
                    <div class="input-group">
                        <label>è„‚è‚ª (g)</label>
                        <input type="number" id="newFat" placeholder="ä¾‹ï¼š8">
                    </div>
                    <div class="input-group">
                        <label>ç¢³æ°´åŒ–åˆç‰© (g)</label>
                        <input type="number" id="newCarbs" placeholder="ä¾‹ï¼š25">
                    </div>
                    <button id="saveProductBtn" class="btn btn-primary">ğŸ’¾ å„²å­˜å•†å“</button>
                    <button class="btn btn-secondary" onclick="hideAddProductForm()">å–æ¶ˆ</button>
                </div>

                <div class="success-message" id="successMessage">å•†å“å·²æˆåŠŸå„²å­˜ï¼</div>

                <div class="manual-input">
                    <h3 style="margin-bottom: 15px; color: #333;">æˆ–æ‰‹å‹•è¼¸å…¥ç‡Ÿé¤Šæˆåˆ†</h3>
                    <div class="input-group">
                        <label>ç†±é‡ (kcal)</label>
                        <input type="number" id="calories" placeholder="ä¾‹ï¼š250">
                    </div>
                    <div class="input-group">
                        <label>è›‹ç™½è³ª (g)</label>
                        <input type="number" id="protein" placeholder="ä¾‹ï¼š20">
                    </div>
                    <div class="input-group">
                        <label>è„‚è‚ª (g)</label>
                        <input type="number" id="fat" placeholder="ä¾‹ï¼š8">
                    </div>
                    <div class="input-group">
                        <label>ç¢³æ°´åŒ–åˆç‰© (g)</label>
                        <input type="number" id="carbs" placeholder="ä¾‹ï¼š25">
                    </div>
                    <button id="calculateBtn" class="btn btn-primary">ğŸ“Š è¨ˆç®—è©•ç´š</button>
                </div>
            </div>

            <div id="databaseTab" class="tab-content">
                <h3 style="margin-bottom: 15px; color: #333;">å·²å„²å­˜çš„å•†å“ (<span id="productCount">0</span>)</h3>
                <div class="product-list" id="productList"></div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨æŸ¥è©¢ç”¢å“è³‡è¨Š...</p>
        </div>

        <div class="error" id="error"></div>

        <div class="card result-card" id="result">
            <div class="product-name" id="productName"></div>
            <div style="text-align: center;">
                <div class="grade-badge" id="gradeBadge"></div>
            </div>

            <div class="nutrition-info">
                <h3 style="margin-bottom: 10px; color: #333;">ç‡Ÿé¤Šæˆåˆ†ï¼ˆæ¯ä»½ï¼‰</h3>
                <div class="nutrition-row">
                    <span class="nutrition-label">ç†±é‡</span>
                    <span class="nutrition-value" id="displayCalories"></span>
                </div>
                <div class="nutrition-row">
                    <span class="nutrition-label">è›‹ç™½è³ª</span>
                    <span class="nutrition-value" id="displayProtein"></span>
                </div>
                <div class="nutrition-row">
                    <span class="nutrition-label">è„‚è‚ª</span>
                    <span class="nutrition-value" id="displayFat"></span>
                </div>
                <div class="nutrition-row">
                    <span class="nutrition-label">ç¢³æ°´åŒ–åˆç‰©</span>
                    <span class="nutrition-value" id="displayCarbs"></span>
                </div>
            </div>

            <div class="score-section">
                <h3 style="margin-bottom: 10px; color: #333;">è©•ä¼°æŒ‡æ¨™</h3>
                <div class="score-item">
                    <span class="score-label">è›‹ç™½è³ªæ•ˆç‡æŒ‡æ¨™ (Ep)</span>
                    <span class="score-value" id="epScore"></span>
                </div>
                <div class="score-item">
                    <span class="score-label">è„‚è‚ªç´„æŸ</span>
                    <span class="score-value" id="fatConstraint"></span>
                </div>
                <div class="score-item">
                    <span class="score-label">ç¢³æ°´ç´„æŸ</span>
                    <span class="score-value" id="carbConstraint"></span>
                </div>
            </div>

            <div class="recommendation" id="recommendation"></div>

            <button class="btn btn-secondary" onclick="resetScanner()">ğŸ”„ æƒæä¸‹ä¸€å€‹ç”¢å“</button>
        </div>
    </div>

    <script>
        let html5QrcodeScanner = null;
        let isScanning = false;
        let currentBarcode = null;

        // ========== è³‡æ–™åº«ç®¡ç†å‡½æ•¸ ==========

        // ç²å–æ‰€æœ‰ç”¢å“
        function getAllProducts() {
            const products = localStorage.getItem('foodProducts');
            return products ? JSON.parse(products) : {};
        }

        // å„²å­˜ç”¢å“åˆ°è³‡æ–™åº«
        function saveProduct(barcode, productData) {
            const products = getAllProducts();
            products[barcode] = productData;
            localStorage.setItem('foodProducts', JSON.stringify(products));
        }

        // æ ¹æ“šæ¢ç¢¼æŸ¥è©¢ç”¢å“
        function getProductByBarcode(barcode) {
            const products = getAllProducts();
            return products[barcode] || null;
        }

        // åˆªé™¤ç”¢å“
        function deleteProduct(barcode) {
            const products = getAllProducts();
            delete products[barcode];
            localStorage.setItem('foodProducts', JSON.stringify(products));
            loadProductList();
        }

        // è¼‰å…¥ç”¢å“åˆ—è¡¨
        function loadProductList() {
            const products = getAllProducts();
            const productList = document.getElementById('productList');
            const productCount = document.getElementById('productCount');
            const count = Object.keys(products).length;

            productCount.textContent = count;

            if (count === 0) {
                productList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">å°šç„¡å„²å­˜çš„å•†å“</p>';
                return;
            }

            productList.innerHTML = '';
            for (const [barcode, product] of Object.entries(products)) {
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.innerHTML = `
                    <div class="product-item-info">
                        <div class="product-item-name">${product.name}</div>
                        <div class="product-item-barcode">æ¢ç¢¼: ${barcode}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            ç†±é‡: ${product.calories}kcal | è›‹ç™½è³ª: ${product.protein}g | è„‚è‚ª: ${product.fat}g | ç¢³æ°´: ${product.carbs}g
                        </div>
                    </div>
                    <button class="btn-delete" onclick="deleteProduct('${barcode}')">åˆªé™¤</button>
                `;
                productList.appendChild(productItem);
            }
        }

        // é¡¯ç¤ºæ–°å¢ç”¢å“è¡¨å–®
        function showAddProductForm(barcode) {
            currentBarcode = barcode;
            document.getElementById('newBarcode').value = barcode;
            document.getElementById('addProductForm').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // éš±è—æ–°å¢ç”¢å“è¡¨å–®
        function hideAddProductForm() {
            document.getElementById('addProductForm').style.display = 'none';
            document.getElementById('newProductName').value = '';
            document.getElementById('newCalories').value = '';
            document.getElementById('newProtein').value = '';
            document.getElementById('newFat').value = '';
            document.getElementById('newCarbs').value = '';
        }

        // åˆ‡æ›åˆ†é 
        function switchTab(tab) {
            const scanTab = document.getElementById('scanTab');
            const databaseTab = document.getElementById('databaseTab');
            const tabBtns = document.querySelectorAll('.tab-btn');

            if (tab === 'scan') {
                scanTab.classList.add('active');
                databaseTab.classList.remove('active');
                tabBtns[0].classList.add('active');
                tabBtns[1].classList.remove('active');
            } else {
                scanTab.classList.remove('active');
                databaseTab.classList.add('active');
                tabBtns[0].classList.remove('active');
                tabBtns[1].classList.add('active');
                loadProductList();
            }
        }

        // ========== ç‡Ÿé¤Šè©•ä¼°å‡½æ•¸ ==========
        function evaluateFood(calories, protein, fat, carbs) {
            // è¨ˆç®—è›‹ç™½è³ªæ•ˆç‡æŒ‡æ¨™ Ep
            const ep = protein / (calories / 100);

            // è„‚è‚ªç´„æŸ: Fat â‰¤ Protein / 2
            const fatConstraintPass = fat <= (protein / 2);

            // ç¢³æ°´ç´„æŸ: Carbs â‰¤ Protein Ã— 1.5
            const carbConstraintPass = carbs <= (protein * 1.5);

            // æ±ºå®šè©•ç´š
            let grade, gradeText, recommendation;

            if (ep >= 12 && fatConstraintPass) {
                grade = 'S+';
                gradeText = 'é ‚ç´š (S+)';
                recommendation = 'ğŸ‰ å®Œç¾ï¼é€™æ˜¯æœ€ç†æƒ³çš„æ¸›è„‚ç‡ƒæ–™ã€‚ç„¡è…¦è³¼è²·ï¼Œéå¸¸é©åˆä½œç‚ºä¸»è¦è›‹ç™½è³ªä¾†æºã€‚';
            } else if (ep >= 7 && ep < 12) {
                grade = 'A';
                gradeText = 'å„ªè‰¯ (A)';
                recommendation = 'ğŸ‘ æ¨è–¦ï¼é€™æ˜¯é«˜æ•ˆçš„æ¸›è„‚é¤é»ï¼Œé©åˆä½œç‚ºæ­£é¤é¸æ“‡ã€‚';
            } else if (ep >= 5 && ep < 7) {
                grade = 'B';
                gradeText = 'è­¦ç¤º (B)';
                recommendation = 'âš ï¸ éœ€è¦å„ªåŒ–ï¼å»ºè­°åƒ…åƒä¸»é£Ÿéƒ¨åˆ†ï¼Œä¸¦é¡å¤–åŠ è³¼ 1 åŒ…é›èƒ¸è‚‰æˆ–è›‹ç™½è³ªå–®å“ä¾†è£œè¶³ã€‚';
            } else {
                grade = 'F';
                gradeText = 'æ·˜æ±° (F)';
                recommendation = 'âŒ ä¸æ¨è–¦ï¼è›‹ç™½è³ªæ•ˆç‡éä½ï¼Œé€™æœƒç ´å£ä½ çš„èƒ°å³¶ç´ æ•æ„Ÿåº¦ï¼Œå»ºè­°é¸æ“‡å…¶ä»–ç”¢å“ã€‚';
            }

            return {
                ep: ep.toFixed(2),
                grade,
                gradeText,
                fatConstraintPass,
                carbConstraintPass,
                recommendation
            };
        }

        // é¡¯ç¤ºè©•ä¼°çµæœ
        function displayResult(productName, calories, protein, fat, carbs, result) {
            document.getElementById('productName').textContent = productName;
            document.getElementById('displayCalories').textContent = `${calories} kcal`;
            document.getElementById('displayProtein').textContent = `${protein} g`;
            document.getElementById('displayFat').textContent = `${fat} g`;
            document.getElementById('displayCarbs').textContent = `${carbs} g`;

            document.getElementById('epScore').textContent = result.ep;
            document.getElementById('epScore').className = 'score-value ' +
                (result.ep >= 7 ? 'score-pass' : 'score-fail');

            document.getElementById('fatConstraint').textContent =
                result.fatConstraintPass ? 'âœ“ ç¬¦åˆ' : 'âœ— ä¸ç¬¦åˆ';
            document.getElementById('fatConstraint').className = 'score-value ' +
                (result.fatConstraintPass ? 'score-pass' : 'score-fail');

            document.getElementById('carbConstraint').textContent =
                result.carbConstraintPass ? 'âœ“ ç¬¦åˆ' : 'âœ— ä¸ç¬¦åˆ';
            document.getElementById('carbConstraint').className = 'score-value ' +
                (result.carbConstraintPass ? 'score-pass' : 'score-fail');

            const badge = document.getElementById('gradeBadge');
            badge.textContent = result.gradeText;
            badge.className = 'grade-badge grade-' + result.grade.toLowerCase().replace('+', 'plus');

            const recDiv = document.getElementById('recommendation');
            recDiv.innerHTML = `<h3>å»ºè­°</h3><p>${result.recommendation}</p>`;

            document.getElementById('result').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // æŸ¥è©¢ç”¢å“è³‡è¨Šï¼ˆå„ªå…ˆæœ¬åœ°è³‡æ–™åº«ï¼Œå…¶æ¬¡ APIï¼‰
        async function getProductInfo(barcode) {
            // 1. å…ˆæŸ¥è©¢æœ¬åœ°è³‡æ–™åº«
            const localProduct = getProductByBarcode(barcode);
            if (localProduct) {
                console.log('å¾æœ¬åœ°è³‡æ–™åº«æ‰¾åˆ°ç”¢å“');
                const result = evaluateFood(
                    localProduct.calories,
                    localProduct.protein,
                    localProduct.fat,
                    localProduct.carbs
                );
                displayResult(
                    localProduct.name,
                    localProduct.calories,
                    localProduct.protein,
                    localProduct.fat,
                    localProduct.carbs,
                    result
                );
                return;
            }

            // 2. æœ¬åœ°æ²’æœ‰ï¼ŒæŸ¥è©¢ API
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}`);
                const data = await response.json();

                if (data.status === 1 && data.product) {
                    const product = data.product;
                    const nutriments = product.nutriments;

                    let calories = nutriments['energy-kcal_100g'] || nutriments['energy-kcal'] || 0;
                    let protein = nutriments['proteins_100g'] || nutriments['proteins'] || 0;
                    let fat = nutriments['fat_100g'] || nutriments['fat'] || 0;
                    let carbs = nutriments['carbohydrates_100g'] || nutriments['carbohydrates'] || 0;

                    if (calories === 0 && protein === 0) {
                        throw new Error('ç”¢å“ç‡Ÿé¤Šè³‡è¨Šä¸å®Œæ•´');
                    }

                    const result = evaluateFood(calories, protein, fat, carbs);
                    const productName = product.product_name || product.product_name_zh || 'æœªçŸ¥ç”¢å“';

                    displayResult(productName, calories, protein, fat, carbs, result);
                } else {
                    throw new Error('æ‰¾ä¸åˆ°ç”¢å“è³‡è¨Š');
                }
            } catch (error) {
                // 3. API ä¹Ÿæ²’æœ‰ï¼Œé¡¯ç¤ºæ–°å¢è¡¨å–®
                console.log('API æŸ¥ç„¡è³‡æ–™ï¼Œé¡¯ç¤ºæ–°å¢è¡¨å–®');
                showAddProductForm(barcode);
            }
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // æ¢ç¢¼æƒææˆåŠŸå›èª¿
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`æƒææˆåŠŸ: ${decodedText}`);
            stopScanning();
            document.getElementById('loading').style.display = 'block';
            document.getElementById('scanner-status').textContent = `æƒæåˆ°æ¢ç¢¼: ${decodedText}`;
            getProductInfo(decodedText);
        }

        // æ¢ç¢¼æƒæå¤±æ•—å›èª¿ï¼ˆéœé»˜è™•ç†ï¼‰
        function onScanFailure(error) {
            // ä¸é¡¯ç¤ºéŒ¯èª¤ï¼Œé¿å…é »ç¹æç¤º
        }

        // é–‹å§‹æƒæ
        function startScanning() {
            if (isScanning) return;

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0,
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39
                ]
            };

            html5QrcodeScanner = new Html5Qrcode("reader");

            html5QrcodeScanner.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).then(() => {
                isScanning = true;
                document.getElementById('startScanBtn').style.display = 'none';
                document.getElementById('stopScanBtn').style.display = 'block';
                document.getElementById('scanner-status').textContent = 'å°æº–å•†å“æ¢ç¢¼...';
            }).catch((err) => {
                showError('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿã€‚è«‹ç¢ºèªå·²æˆäºˆç›¸æ©Ÿæ¬Šé™ã€‚');
                console.error(err);
            });
        }

        // åœæ­¢æƒæ
        function stopScanning() {
            if (!isScanning || !html5QrcodeScanner) return;

            html5QrcodeScanner.stop().then(() => {
                isScanning = false;
                document.getElementById('startScanBtn').style.display = 'block';
                document.getElementById('stopScanBtn').style.display = 'none';
                document.getElementById('scanner-status').textContent = 'æƒæå·²åœæ­¢';
            }).catch((err) => {
                console.error(err);
            });
        }

        // é‡ç½®æƒæå™¨
        function resetScanner() {
            document.getElementById('result').style.display = 'none';
            document.getElementById('scanner-status').textContent = 'æº–å‚™æƒæ...';

            // æ¸…ç©ºæ‰‹å‹•è¼¸å…¥
            document.getElementById('calories').value = '';
            document.getElementById('protein').value = '';
            document.getElementById('fat').value = '';
            document.getElementById('carbs').value = '';
        }

        // æ‰‹å‹•è¨ˆç®—
        document.getElementById('calculateBtn').addEventListener('click', () => {
            const calories = parseFloat(document.getElementById('calories').value);
            const protein = parseFloat(document.getElementById('protein').value);
            const fat = parseFloat(document.getElementById('fat').value);
            const carbs = parseFloat(document.getElementById('carbs').value);

            if (!calories || !protein || !fat || !carbs) {
                showError('è«‹å¡«å¯«æ‰€æœ‰ç‡Ÿé¤Šæˆåˆ†');
                return;
            }

            const result = evaluateFood(calories, protein, fat, carbs);
            displayResult('æ‰‹å‹•è¼¸å…¥çš„ç”¢å“', calories, protein, fat, carbs, result);
        });

        // å„²å­˜æ–°ç”¢å“
        document.getElementById('saveProductBtn').addEventListener('click', () => {
            const name = document.getElementById('newProductName').value;
            const calories = parseFloat(document.getElementById('newCalories').value);
            const protein = parseFloat(document.getElementById('newProtein').value);
            const fat = parseFloat(document.getElementById('newFat').value);
            const carbs = parseFloat(document.getElementById('newCarbs').value);

            if (!name || !calories || !protein || !fat || !carbs) {
                showError('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
                return;
            }

            // å„²å­˜åˆ°è³‡æ–™åº«
            saveProduct(currentBarcode, {
                name: name,
                calories: calories,
                protein: protein,
                fat: fat,
                carbs: carbs
            });

            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            const successMsg = document.getElementById('successMessage');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);

            // éš±è—è¡¨å–®
            hideAddProductForm();

            // é¡¯ç¤ºè©•ä¼°çµæœ
            const result = evaluateFood(calories, protein, fat, carbs);
            displayResult(name, calories, protein, fat, carbs, result);
        });

        // æŒ‰éˆ•äº‹ä»¶
        document.getElementById('startScanBtn').addEventListener('click', startScanning);
        document.getElementById('stopScanBtn').addEventListener('click', stopScanning);

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', () => {
            loadProductList();
        });
    </script>
</body>
</html>
